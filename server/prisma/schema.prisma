// prisma/schema.prisma
// Mass Tracking System 2026 - MongoDB Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ====================================================================
// CORE MODELS FOR MASS TRACKING SYSTEM - 9 MODELS
// ====================================================================

model User {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  username              String     @unique
  passwordHash          String
  email                 String?
  name                  String?
  province              String?
  congregation          String?
  dateOfBirth           DateTime?
  dateOfOrdination      DateTime?

  blockedDays           BlockedDay[]
  fixedIntentions       FixedIntention[]
  deceasedMembers       Deceased[]
  gregorianMasses       GregorianMass[]
  personalIntentions    PersonalIntention[]
  massBatches           MassBatch[]
  scheduledMasses       ScheduledMass[]
  schedulerRuns         SchedulerRun[]

  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
}

model BlockedDay {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  userId                String     @db.ObjectId
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  date                  DateTime
  reason                String
  reasonType            String
  isAvailable           Boolean    @default(false)

  createdAt             DateTime   @default(now())

  @@index([userId])
  @@index([date])
}

model FixedIntention {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  userId                String     @db.ObjectId
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  dateOfMonth           Int
  monthOnlyFlag         Boolean    @default(false)
  type                  String
  conflictFlag          Boolean    @default(false)
  description           String?

  scheduledMasses       ScheduledMass[]

  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  @@index([userId])
}

model Deceased {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  userId                String     @db.ObjectId
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  name                  String
  dateOfDeath           DateTime
  funeralDate           DateTime?
  manualDateFlag        Boolean    @default(false)
  scheduleDateOverride  DateTime?

  targetDate            DateTime
  massScheduledDate     DateTime?
  conflictFlag          Boolean    @default(false)

  scheduledMasses       ScheduledMass[]

  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  @@index([userId])
  @@index([dateOfDeath])
}

model GregorianMass {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  userId                String     @db.ObjectId
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  batchId               String     @db.ObjectId
  batch                 MassBatch  @relation(fields: [batchId], references: [id], onDelete: Cascade)

  donorName             String
  seriesNumber          Int
  startDate             DateTime
  pausedUntilDate       DateTime?
  status                String

  scheduledMasses       ScheduledMass[]

  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  @@index([userId])
  @@index([batchId])
}

model PersonalIntention {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  userId                String     @db.ObjectId
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  description           String
  month                 Int
  scheduledDate         DateTime?

  scheduledMasses       ScheduledMass[]

  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  @@index([userId])
  @@index([month])
}

model MassBatch {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  userId                String     @db.ObjectId
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  code                  String
  totalIntentions       Int
  seriesType            String
  dateReceived          DateTime   @default(now())
  startIndex            Int

  scheduledCount        Int        @default(0)
  completedCount        Int        @default(0)
  notes                 String?

  gregorianMasses       GregorianMass[]
  scheduledMasses       ScheduledMass[]

  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  @@index([userId])
  @@index([code])
}

model ScheduledMass {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  userId                String     @db.ObjectId
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  date                  DateTime
  massType              String
  intentionDescription  String?
  serialNumber          Int?

  batchId               String?    @db.ObjectId
  batch                 MassBatch? @relation(fields: [batchId], references: [id])

  deceasedMemberId      String?    @db.ObjectId
  deceasedMember        Deceased?  @relation(fields: [deceasedMemberId], references: [id])

  fixedIntentionId      String?    @db.ObjectId
  fixedIntention        FixedIntention? @relation(fields: [fixedIntentionId], references: [id])

  gregorianMassId       String?    @db.ObjectId
  gregorianMass         GregorianMass? @relation(fields: [gregorianMassId], references: [id])

  personalIntentionId   String?    @db.ObjectId
  personalIntention     PersonalIntention? @relation(fields: [personalIntentionId], references: [id])

  externalBatchCode     String?
  celebrated            Boolean    @default(false)

  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt

  @@index([userId])
  @@index([date])
  @@index([massType])
}

model SchedulerRun {
  id                    String     @id @default(auto()) @map("_id") @db.ObjectId
  userId                String     @db.ObjectId
  user                  User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  runDateTime           DateTime   @default(now())
  status                String
  conflictsDetected     Json
  notesLog              Json
  totalMassesScheduled  Int        @default(0)
  totalConflicts        Int        @default(0)

  createdAt             DateTime   @default(now())

  @@index([userId])
  @@index([runDateTime])
}
